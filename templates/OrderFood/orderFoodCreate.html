{% extends "Shared/dashboard.html" %}
{% load static %}
{% block content %}

<style>
    .custom-radio-group {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .custom-radio input[type="radio"] {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #007bff;
        border-radius: 50%;
        margin-right: 8px;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .custom-radio input[type="radio"]:checked {
        background-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
    }

    .custom-radio {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        font-size: 1.1rem;
        color: #333;
    }

    .custom-radio:hover input[type="radio"] {
        border-color: #0056b3;
    }

    .radio-label {
        margin-left: 6px;
    }
    
    /* Improved table styling */
    #order-summary {
        font-size: 0.9rem;
    }
    
    #order-summary thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 12px 8px;
    }
    
    #order-summary tbody td {
        vertical-align: middle;
        padding: 10px 8px;
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.25em 0.6em;
    }
    
    .dynamic-qty {
        width: 70px !important;
    }
</style>

<!-- In your orderFoodCreate.html, add this after the form -->
<!-- TAX RATES FROM DATABASE -->
<input type="hidden" id="food-gst-rate" value="{{ tax_rates.food_gst }}">
<input type="hidden" id="drink-gst-rate" value="{{ tax_rates.drink_gst }}">
<input type="hidden" id="service-charge-rate" value="{{ tax_rates.service_charge }}">
<input type="hidden" id="service-charge-enabled" value="{{ tax_rates.service_enabled|yesno:'1,0' }}">

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h2 class="m-0 font-weight-bold text-primary">Order Food</h2>
    </div>
    
    <div class="card-body">
        <input type="hidden" name="TableCategory" id="TableCategory" value="{{ Category }}">
        <form method="POST" id="myForm">
            {% csrf_token %}
        </form>

        <div class="row">
            <!-- LEFT SIDE: CONTROLS & ORDER TABLE -->
            <div class="col-md-8">
                <!-- CONTROLS CARD -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Add Items</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Table Number -->
                            {% if tableName %}
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label font-weight-bold">Table Number</label>
                                    <input type="text" id="service-dropdown" name="service-dropdown" 
                                           value="{{ tableName }}" class="form-control" readonly />
                                </div>
                            </div>
                            {% endif %}

                            <!-- Add Dish -->
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label class="form-label font-weight-bold">Add Dish</label>
                                    <input list="dish-list" id="next-dropdown" class="form-control" 
                                           placeholder="Type dish name...">
                                    <datalist id="dish-list">
                                        {% for dish in menu_items %}
                                            <option value="{{ dish }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                            </div>

                            <!-- Portion Size - Updated with dynamic controls -->
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label font-weight-bold d-block">Portion</label>
                                    <div id="portion-controls">
                                        <!-- Dynamic controls will be loaded here -->
                                        <div class="custom-radio-group">
                                            <label class="custom-radio">
                                                <input type="radio" name="quantity" value="H">
                                                <span class="radio-label">Half</span>
                                            </label>
                                            <label class="custom-radio">
                                                <input type="radio" name="quantity" value="F">
                                                <span class="radio-label">Full</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SELECTED ORDERS TABLE -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Selected Orders</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover mb-0" id="order-summary">
                                <thead class="thead-light sticky-top" style="top: 0;">
                                    <tr>
                                        <th>Dish</th>
                                        <th>Category</th>
                                        <th>Portion</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic rows will be added here via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDE: BILLING SUMMARY -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100" id="billingSummaryCard">
                    <!-- Restaurant Header -->
                    <div class="text-center p-3 bg-dark text-white">
                        <h4 class="mb-1">Restaurant Name</h4>
                        <p class="mb-0 small">Your Restaurant Slogan Here</p>
                        <hr class="my-2" style="border-color: rgba(255,255,255,0.2)">
                    </div>
                    
                    <!-- Bill Details -->
                    <div class="p-3" style="height: calc(100% - 180px); overflow-y: auto;">
                        <!-- Order Info -->
                        <div class="row mb-2 small">
                            <div class="col-6">
                                <strong>Bill No:</strong> <span id="bill-number">New</span>
                            </div>
                            <div class="col-6 text-right">
                                <strong>Date:</strong> <span id="bill-date"></span>
                            </div>
                        </div>
                        <div class="row mb-3 small">
                            <div class="col-12">
                                <strong>Table:</strong> <span id="bill-table">{{ tableName }}</span>
                                <span id="bill-category" class="text-muted">{% if Category %}({{ Category }}){% endif %}</span>
                            </div>
                        </div>
                        
                        <!-- Items Table -->
                        <div class="table-responsive mb-3">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr class="bg-light">
                                        <th class="py-1" style="width: 40%">Item</th>
                                        <th class="py-1 text-center" style="width: 20%">Type</th>
                                        <th class="py-1 text-center" style="width: 15%">Qty</th>
                                        <th class="py-1 text-right" style="width: 25%">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="restaurant-bill-items">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Calculations -->
                        <div class="border-top pt-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Subtotal</span>
                                <span id="restaurant-subtotal">â‚¹0.00</span>
                            </div>
                            
                            <!-- ADD GST TOGGLE HERE -->
                            <div class="form-check mb-2 small">
                                <input class="form-check-input" type="checkbox" id="apply-gst-checkbox" checked>
                                <label class="form-check-label" for="apply-gst-checkbox">
                                    Apply GST & Service Charges
                                </label>
                            </div>
                            
                            <!-- Tax Breakdown (Dynamic) -->
                            <div id="tax-breakdown">
                                <!-- Will show: Food GST @5% = â‚¹XX.XX -->
                                <!-- Will show: Drink GST @18% = â‚¹XX.XX -->
                                <!-- Will show: Service Charge @5% = â‚¹XX.XX -->
                            </div>
                            
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <strong>TOTAL PAYABLE</strong>
                                <strong id="restaurant-grand-total">â‚¹0.00</strong>
                            </div>
                        </div>
                        
                        <!-- Footer Note -->
                        <div class="text-center mt-3 small text-muted">
                            Thank you for dining with us!
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-4">
                                <button class="btn btn-secondary w-100" id="go-back-btn">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-primary w-100" id="save-order-btn">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-success w-100" id="save-print-btn">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    // Global variable to track current item measurement type
    let currentMeasurementType = 'half_full';
    
    // Set current date for bill
    $(document).ready(function() {
        const now = new Date();
        const formattedDate = now.toLocaleDateString('en-GB');
        $('#bill-date').text(formattedDate);
    });

    // Function to check if category is a drink
    function isDrinkCategory(category, menuType) {
        if (!category) return false;
        
        const lowerCategory = category.toLowerCase().trim();
        const lowerMenuType = (menuType || '').toLowerCase().trim();
        
        // Alcoholic drinks get 18% GST
        const alcoholicKeywords = [
            'alcohol', 'cocktail', 'wine', 'beer', 'spirit', 'liquor', 'bar',
            'whisky', 'vodka', 'rum', 'gin', 'tequila', 'brandy'
        ];
        
        // Non-alcoholic drinks (soft drinks, juices) get 5% GST
        const nonAlcoholicKeywords = [
            'soft drink', 'juice', 'cola', 'soda', 'water', 'coffee', 'tea'
        ];
        
        // Check if it's an alcoholic drink
        return alcoholicKeywords.some(keyword => 
            lowerCategory.includes(keyword) || 
            lowerMenuType.includes(keyword)
        );
    }

    // Function to check for duplicates
    function isDishAlreadyAdded(dishName, portionType, measurementType) {
        let isDuplicate = false;
        
        $('#order-summary tbody tr').each(function () {
            const existingDish = $(this).find('td:eq(0)').text();
            
            if (existingDish === dishName) {
                isDuplicate = true;
                return false;
            }
        });
        
        return isDuplicate;
    }

    // SIMPLE TAX CALCULATION
    function updateBillSummary() {
        let foodTotal = 0;
        let drinkTotal = 0;
        const items = [];
        
        // Get rates from hidden fields
        const foodGstRate = parseFloat($('#food-gst-rate').val()) || 5;
        const drinkGstRate = parseFloat($('#drink-gst-rate').val()) || 18;
        const serviceChargeRate = parseFloat($('#service-charge-rate').val()) || 5;
        const serviceChargeEnabled = $('#service-charge-enabled').val() === '1';
        
        // Check if GST should be applied
        const applyGst = $('#apply-gst-checkbox').is(':checked');
        
        // Clear bill items
        $('#restaurant-bill-items').empty();
        
        // Process each item
        $('#order-summary tbody tr').each(function () {
            const menuName = $(this).find('td:eq(0)').text();
            const category = $(this).find('td:eq(1)').text()
                .replace('badge-info', '')
                .replace('badge', '')
                .replace(/<[^>]*>/g, '')
                .trim();
            const qtyType = $(this).find('td:eq(2)').text().trim();
            const qty = parseInt($(this).find('.dynamic-qty').val()) || 1;
            const priceText = $(this).find('.price-cell').text().replace('â‚¹', '');
            const itemTotal = parseFloat(priceText) || 0;
            
            const isDrink = isDrinkCategory(category);
            
            if (isDrink) {
                drinkTotal += itemTotal;
            } else {
                foodTotal += itemTotal;
            }
            
            items.push({
                name: menuName,
                total: itemTotal,
                isDrink: isDrink
            });
            
            // Add to bill display
            $('#restaurant-bill-items').append(`
                <tr>
                    <td class="small py-1">${menuName}</td>
                    <td class="text-center small py-1">
                        <span class="badge ${qtyType.includes('Half') ? 'badge-warning' : qtyType.includes('Full') ? 'badge-success' : 'badge-primary'}">
                            ${qtyType}
                        </span>
                    </td>
                    <td class="text-center small py-1">${qty}</td>
                    <td class="text-right small py-1">â‚¹${itemTotal.toFixed(2)}</td>
                </tr>
            `);
        });
        
        // Calculate amounts
        const subtotal = foodTotal + drinkTotal;
        
        // Only calculate taxes if GST checkbox is checked
        let foodGst = 0;
        let drinkGst = 0;
        let totalGst = 0;
        let serviceCharge = 0;
        
        if (applyGst) {
            foodGst = (foodTotal * foodGstRate) / 100;
            drinkGst = (drinkTotal * drinkGstRate) / 100;
            totalGst = foodGst + drinkGst;
            
            if (serviceChargeEnabled) {
                serviceCharge = (subtotal * serviceChargeRate) / 100;
            }
        }
        
        const grandTotal = subtotal + totalGst + serviceCharge;
        
        // UPDATE DISPLAY
        $('#restaurant-subtotal').text(`â‚¹${subtotal.toFixed(2)}`);
        
        // Build tax display - only show if GST is applied
        let taxHtml = '';
        
        if (applyGst) {
            if (foodTotal > 0 && foodGst > 0) {
                taxHtml += `<div class="d-flex justify-content-between mb-1 small">
                    <span>Food GST @${foodGstRate}%</span>
                    <span>â‚¹${foodGst.toFixed(2)}</span>
                </div>`;
            }
            
            if (drinkTotal > 0 && drinkGst > 0) {
                taxHtml += `<div class="d-flex justify-content-between mb-1 small">
                    <span>Drink GST @${drinkGstRate}%</span>
                    <span>â‚¹${drinkGst.toFixed(2)}</span>
                </div>`;
            }
            
            if (serviceChargeEnabled && serviceCharge > 0) {
                taxHtml += `<div class="d-flex justify-content-between mb-1 small">
                    <span>Service Charge @${serviceChargeRate}%</span>
                    <span>â‚¹${serviceCharge.toFixed(2)}</span>
                </div>`;
            }
        } else {
            taxHtml = `<div class="text-muted small mb-1">
                <i>GST & Service Charges not applied</i>
            </div>`;
        }
        
        // Update tax breakdown
        $('#tax-breakdown').html(taxHtml);
        $('#restaurant-grand-total').text(`â‚¹${grandTotal.toFixed(2)}`);
        
        // Return data for printing
        return {
            subtotal: subtotal,
            foodGst: foodGst,
            drinkGst: drinkGst,
            totalGst: totalGst,
            serviceCharge: serviceCharge,
            grandTotal: grandTotal,
            items: items,
            foodGstRate: foodGstRate,
            drinkGstRate: drinkGstRate,
            applyGst: applyGst
        };
    }

    // When dish is selected, check its type and update UI
    $('#next-dropdown').on('input', function() {
        const selectedDish = $(this).val();
        const category = $('#TableCategory').val();
        
        if (!selectedDish) {
            // Reset to default if empty
            currentMeasurementType = 'half_full';
            $('#portion-controls').html(`
                <div class="custom-radio-group">
                    <label class="custom-radio">
                        <input type="radio" name="quantity" value="H">
                        <span class="radio-label">Half</span>
                    </label>
                    <label class="custom-radio">
                        <input type="radio" name="quantity" value="F">
                        <span class="radio-label">Full</span>
                    </label>
                </div>
            `);
            return;
        }
        
        // Get dish details
        $.ajax({
            url: "{% url 'get_dish_details' %}",
            type: 'GET',
            data: {
                dish_name: selectedDish,
                category: category
            },
            success: function(response) {
                if (response.success) {
                    const item = response.item;
                    currentMeasurementType = item.menu_measurement;
                    
                    // IMPORTANT: If measurement is NOT half_full, auto-add to order
                    if (currentMeasurementType !== 'half_full') {
                        // Auto-add the item with default quantity 1
                        autoAddNonHalfFullItem(selectedDish, item);
                        
                        // Clear the dropdown after adding
                        $('#next-dropdown').val('');
                        
                        // Show simple message instead of controls
                        $('#portion-controls').html(`
                            <div class="alert alert-success py-2 mb-0 small">
                                <i class="fas fa-check-circle"></i> Added to order
                            </div>
                        `);
                        
                        // Reset after 1.5 seconds
                        setTimeout(() => {
                            $('#portion-controls').html(`
                                <div class="custom-radio-group">
                                    <label class="custom-radio">
                                        <input type="radio" name="quantity" value="H">
                                        <span class="radio-label">Half</span>
                                    </label>
                                    <label class="custom-radio">
                                        <input type="radio" name="quantity" value="F">
                                        <span class="radio-label">Full</span>
                                    </label>
                                </div>
                            `);
                            currentMeasurementType = 'half_full';
                        }, 1500);
                    } else {
                        // For half/full items, show radio buttons as before
                        $('#portion-controls').html(`
                            <div class="custom-radio-group">
                                <label class="custom-radio">
                                    <input type="radio" name="quantity" value="H">
                                    <span class="radio-label">Half</span>
                                </label>
                                <label class="custom-radio">
                                    <input type="radio" name="quantity" value="F">
                                    <span class="radio-label">Full</span>
                                </label>
                            </div>
                        `);
                        // Clear any radio selection
                        $('input[name="quantity"]').prop('checked', false);
                    }
                } else {
                    // Default to half/full if not found
                    currentMeasurementType = 'half_full';
                    $('#portion-controls').html(`
                        <div class="custom-radio-group">
                            <label class="custom-radio">
                                <input type="radio" name="quantity" value="H">
                                <span class="radio-label">Half</span>
                            </label>
                            <label class="custom-radio">
                                <input type="radio" name="quantity" value="F">
                                <span class="radio-label">Full</span>
                            </label>
                        </div>
                    `);
                }
            },
            error: function() {
                // If API fails, show default half/full
                currentMeasurementType = 'half_full';
                $('#portion-controls').html(`
                    <div class="custom-radio-group">
                        <label class="custom-radio">
                            <input type="radio" name="quantity" value="H">
                            <span class="radio-label">Half</span>
                        </label>
                        <label class="custom-radio">
                            <input type="radio" name="quantity" value="F">
                            <span class="radio-label">Full</span>
                        </label>
                    </div>
                `);
            }
        });
    });

    // Function to auto-add non-half_full items
        // Function to auto-add non-half_full items
    function autoAddNonHalfFullItem(dishName, itemDetails) {
        const selectedService = $('#service-dropdown').val();
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const Category = $('#TableCategory').val();
        
        if (!selectedService) {
            Swal.fire('Warning', 'Please select a table first.', 'warning');
            return;
        }
        
        // Check if item already exists
        if (isDishAlreadyAdded(dishName, 'default', itemDetails.menu_measurement)) {
            Swal.fire('Info', `${dishName} is already in the order. You can increase quantity using the quantity field.`, 'info');
            return;
        }
        
        // Prepare data for the item
        const formData = new FormData();
        formData.append('service', selectedService);
        formData.append('Category', Category);
        formData.append('dish', dishName);
        formData.append('quantity', 'F'); // Always 'F' for non-half_full items
        
        // Add appropriate data based on measurement type
        switch(itemDetails.menu_measurement) {
            case 'piece':
            case 'bottle':
            case 'glass':
            case 'slice':
            case 'plate':
                formData.append('qty', 1); // Default quantity 1
                break;
            case 'ml':
                // For ml items, check if measurement_unit has a specific size
                if (itemDetails.measurement_unit && itemDetails.measurement_unit.includes('ml')) {
                    // Extract the ml value from measurement_unit (e.g., "500ml" -> 500)
                    const mlMatch = itemDetails.measurement_unit.match(/(\d+)ml/);
                    if (mlMatch) {
                        formData.append('ml_qty', mlMatch[1]); // Use the specific size from database
                    } else {
                        formData.append('ml_qty', 500); // Default fallback
                    }
                } else {
                    formData.append('ml_qty', 500); // Default fallback
                }
                break;
            default:
                formData.append('qty', 1);
        }
        
        formData.append('finalOrder', 'finalOrder');
        formData.append('csrfmiddlewaretoken', csrftoken);

        // Send to server
        $.ajax({
            url: "{% url 'orderCreate' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                if (response.menu_item) {
                    const item = response.menu_item;
                    const dish = item.menu_name;
                    const category = item.menu_category;
                    const qtyDisplay = item.qty_display || '1 item';
                    const unitPrice = parseFloat(item.unit_price) || 0;
                    const totalPrice = parseFloat(item.total_price) || 0;
                    
                    console.log('Item added:', item); // Debug log
                    
                    // Determine badge class
                    let badgeClass = 'badge-primary';
                    
                    const rowHtml = `
                        <tr data-unit-price="${unitPrice}" data-measurement="${item.menu_measurement || 'other'}" data-total-price="${totalPrice}">
                            <td>${dish}</td>
                            <td><span class="badge badge-info">${category}</span></td>
                            <td><span class="badge ${badgeClass}">${qtyDisplay}</span></td>
                            <td>
                                <input type="number" class="form-control form-control-sm dynamic-qty" 
                                    min="1" value="1" style="width: 70px;">
                            </td>
                            <td class="price-cell font-weight-bold">â‚¹${totalPrice.toFixed(2)}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;

                    $('#order-summary tbody').append(rowHtml);
                    updateBillSummary();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Item Added!',
                        text: `${dish} added to order`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else if (response.error) {
                    Swal.fire('Error', response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Order submission error:', error);
                Swal.fire('Error', 'Item not found or not available', 'error');
            }
        });
    }

    // Event handler for radio buttons (half/full items only)
    $(document).on('change', 'input[name="quantity"]', function () {
        // Only trigger for half/full items
        if (currentMeasurementType === 'half_full') {
            addHalfFullItemToOrder();
        }
    });

    // Also handle click on radio labels
    $(document).on('click', '.custom-radio', function() {
        const radio = $(this).find('input[name="quantity"]');
        if (!radio.is(':checked')) {
            radio.prop('checked', true).trigger('change');
        }
    });

    // Function to add half/full item to order
    function addHalfFullItemToOrder() {
        const selectedService = $('#service-dropdown').val();
        const selectedDish = $('#next-dropdown').val();
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const Category = $('#TableCategory').val();
        
        let selectedQty = $('input[name="quantity"]:checked').val();
        
        if (!selectedQty) {
            Swal.fire('Warning', 'Please select portion size (Half/Full).', 'warning');
            return;
        }
        
        const qtyText = selectedQty === 'H' ? 'Half' : 'Full';
        
        if (!selectedService) {
            Swal.fire('Warning', 'Please select a table first.', 'warning');
            return;
        }

        if (!selectedDish) {
            Swal.fire('Warning', 'Please select a dish first.', 'warning');
            return;
        }

        // Check if dish already exists
        let existingRow = null;
        let existingQtyValue = 0;
        
        $('#order-summary tbody tr').each(function () {
            const existingDish = $(this).find('td:eq(0)').text();
            const existingPortion = $(this).find('td:eq(2)').text().trim();
            
            // For half/full, check exact dish + portion
            if (existingDish === selectedDish && existingPortion === qtyText) {
                existingRow = $(this);
                existingQtyValue = parseInt($(this).find('.dynamic-qty').val()) || 1;
                return false; // Break loop
            }
        });
        
        // If item already exists, increase quantity
        if (existingRow) {
            const newQty = existingQtyValue + 1;
            existingRow.find('.dynamic-qty').val(newQty);
            
            // Update price
            const unitPrice = parseFloat(existingRow.data('unit-price'));
            const updatedTotal = (unitPrice * newQty).toFixed(2);
            existingRow.find('.price-cell').text(`â‚¹${updatedTotal}`);
            
            // Update bill
            updateBillSummary();
            
            // Show success message
            Swal.fire('Quantity Updated', `Increased ${selectedDish} (${qtyText}) quantity to ${newQty}`, 'success');
            
            // Reset form for next entry
            $('#next-dropdown').val('');
            $('input[name="quantity"]').prop('checked', false);
            return; // Don't proceed with AJAX call
        }

        const formData = new FormData();
        formData.append('service', selectedService);
        formData.append('Category', Category);
        formData.append('dish', selectedDish);
        formData.append('quantity', selectedQty);
        formData.append('finalOrder', 'finalOrder');
        formData.append('csrfmiddlewaretoken', csrftoken);

        $.ajax({
            url: "{% url 'orderCreate' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                if (response.menu_item) {
                    const item = response.menu_item;
                    const dish = item.menu_name;
                    const category = item.menu_category;
                    const qtyDisplay = item.qty_display || (item.selected_qty === 'H' ? 'Half' : 'Full');
                    const unitPrice = parseFloat(item.unit_price) || 0;
                    const totalPrice = parseFloat(item.total_price) || 0;
                    
                    // Determine badge class
                    let badgeClass = item.selected_qty === 'H' ? 'badge-warning' : 'badge-success';
                    
                    const rowHtml = `
                        <tr data-unit-price="${unitPrice}" data-measurement="${item.menu_measurement || 'half_full'}" data-total-price="${totalPrice}">
                            <td>${dish}</td>
                            <td><span class="badge badge-info">${category}</span></td>
                            <td><span class="badge ${badgeClass}">${qtyDisplay}</span></td>
                            <td>
                                <input type="number" class="form-control form-control-sm dynamic-qty" 
                                    min="1" value="1" style="width: 70px;">
                            </td>
                            <td class="price-cell font-weight-bold">â‚¹${totalPrice.toFixed(2)}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;

                    $('#order-summary tbody').append(rowHtml);
                    updateBillSummary();
                    
                    // Reset form for next entry
                    $('#next-dropdown').val('');
                    $('input[name="quantity"]').prop('checked', false);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Item Added!',
                        text: `${dish} (${qtyDisplay}) added to order`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else if (response.error) {
                    Swal.fire('Error', response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Order submission error:', error);
                Swal.fire('Error', 'Item not found or not available', 'error');
            }
        });
    }

    // Quantity change updates
    $(document).on('input', '.dynamic-qty', function () {
        const qty = parseInt($(this).val()) || 0;

        if (qty <= 0) {
            Swal.fire('Warning', 'Quantity must be at least 1!', 'warning');
            $(this).val(1);
            return;
        }

        const row = $(this).closest('tr');
        const dish = row.find('td:eq(0)').text();
        const category = row.find('td:eq(1) .badge').text();
        const measurementType = row.data('measurement') || 'half_full';
        const selectedService = $('#service-dropdown').val();
        const Category = $('#TableCategory').val();
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Prepare data for backend
        const formData = new FormData();
        formData.append('service', selectedService);
        formData.append('Category', Category);
        formData.append('dish', dish);
        formData.append('quantity', 'F'); // Default to 'F' for quantity-based items
        
        // For piece/bottle/glass/slice/plate items
        if (measurementType === 'piece' || measurementType === 'bottle' || 
            measurementType === 'glass' || measurementType === 'slice' || 
            measurementType === 'plate') {
            formData.append('qty', qty);
        }
        // For ml items - get the ml_qty from the portion text
        else if (measurementType === 'ml') {
            const portionText = row.find('td:eq(2) .badge').text();
            const mlMatch = portionText.match(/(\d+)ml/);
            if (mlMatch) {
                formData.append('ml_qty', mlMatch[1]);
                formData.append('qty', qty);
            }
        }
        // For half/full items
        else if (measurementType === 'half_full') {
            const portionText = row.find('td:eq(2) .badge').text();
            const selectedQty = portionText === 'Half' ? 'H' : 'F';
            formData.append('quantity', selectedQty);
            formData.append('qty', qty);
        }
        
        formData.append('finalOrder', 'finalOrder');
        formData.append('csrfmiddlewaretoken', csrftoken);

        // Call backend to get updated price
        $.ajax({
            url: "{% url 'orderCreate' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                if (response.menu_item) {
                    const item = response.menu_item;
                    const totalPrice = parseFloat(item.total_price) || 0;
                    
                    // Update the row with new price
                    row.find('.price-cell').text(`â‚¹${totalPrice.toFixed(2)}`);
                    row.data('unit-price', parseFloat(item.unit_price) || 0);
                    row.data('total-price', totalPrice);
                    
                    // Update portion text for quantity-based items
                    if (measurementType !== 'half_full') {
                        row.find('td:eq(2) .badge').text(item.qty_display || `${qty} item`);
                    }
                    
                    // Update bill summary
                    updateBillSummary();
                }
            },
            error: function(xhr, status, error) {
                console.error('Price update error:', error);
                Swal.fire('Error', 'Failed to update price', 'error');
            }
        });
    });

    // Delete row with confirmation
    $(document).on('click', '.delete-row', function () {
        const row = $(this).closest('tr');
        const dishName = row.find('td:eq(0)').text();
        const portionType = row.find('td:eq(2)').text().trim();
        
        Swal.fire({
            title: 'Remove Item',
            text: `Remove ${dishName} (${portionType}) from order?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, remove it'
        }).then((result) => {
            if (result.isConfirmed) {
                row.remove();
                updateBillSummary();
                Swal.fire('Removed', 'Item removed from order', 'success');
            }
        });
    });

    // Save Order Button
    $('#save-order-btn').on('click', function () {
        const selectedService = $('#service-dropdown').val();
        const orderItems = [];
        const TableCategory = $('#TableCategory').val();
        const billData = updateBillSummary();

        $('#order-summary tbody tr').each(function () {
            const dish = $(this).find('td:eq(0)').text();
            const category = $(this).find('td:eq(1)').text().replace('badge-info', '').replace('badge', '').trim();
            const quantity_type = $(this).find('td:eq(2)').text();
            const quantity = $(this).find('td:eq(3) input').val();
            const priceText = $(this).find('td:eq(4)').text().replace('â‚¹', '');
            const price = parseFloat(priceText);
            const measurementType = $(this).data('measurement') || 'half_full';

            orderItems.push({
                menu_name: dish,
                menu_category: category,
                quantity_type: measurementType === 'half_full' ? (quantity_type === 'Half' ? 'H' : 'F') : 'F',
                quantity: quantity,
                price: price,
                measurement_type: measurementType
            });
        });

        if (!selectedService || orderItems.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please select a table and add at least one item.'
            });
            return;
        }

        const csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

        const formData = new FormData();
        formData.append('table_no', selectedService);
        formData.append('order_items', JSON.stringify(orderItems));
        formData.append('total_amount', billData.subtotal);
        formData.append('gst_applied', $('#apply-gst-checkbox').is(':checked') ? 1 : 0);
        formData.append('gst_amount', billData.totalGst);
        formData.append('grand_total', billData.grandTotal);
        formData.append('csrfmiddlewaretoken', csrftoken);
        formData.append('TableCategory', TableCategory);

        $.ajax({
            url: "{% url 'orderStoreDetails' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function (response) {
                Swal.fire({
                    icon: 'success',
                    title: 'Order Placed!',
                    text: 'Your order has been placed successfully! ðŸŽ‰',
                    confirmButtonText: 'Okay'
                }).then(function () {
                    window.location.href = '{% url "orderDetailIndex" %}';
                });
            },
            error: function (xhr, status, error) {
                console.error("Order submission failed:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Something went wrong',
                    text: 'An error occurred while placing the order. Please try again.'
                });
            }
        });
    });

    // Print Bill Function
    $('#save-print-btn').on('click', function() {
        const billData = updateBillSummary();
        const printWindow = window.open('', '_blank');
        
        // Build tax details for print
        let taxDetails = '';
        if (billData.foodGst > 0) {
            taxDetails += `<p>Food GST @${billData.foodGstRate}%: â‚¹${billData.foodGst.toFixed(2)}</p>`;
        }
        if (billData.drinkGst > 0) {
            taxDetails += `<p>Drink GST @${billData.drinkGstRate}%: â‚¹${billData.drinkGst.toFixed(2)}</p>`;
        }
        if (billData.serviceCharge > 0) {
            taxDetails += `<p>Service Charge: â‚¹${billData.serviceCharge.toFixed(2)}</p>`;
        }
        
        printWindow.document.write(`
            <html>
                <head><title>Bill</title></head>
                <body style="font-family: monospace; padding: 15px;">
                    <h3 style="text-align: center;">PRU AF RESTAURANT</h3>
                    <hr>
                    <p><strong>Table:</strong> ${$('#service-dropdown').val()}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                    <hr>
                    
                    <table width="100%">
                        ${billData.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td align="right">â‚¹${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <hr>
                    <p>Subtotal: â‚¹${billData.subtotal.toFixed(2)}</p>
                    ${taxDetails}
                    <h3>Grand Total: â‚¹${billData.grandTotal.toFixed(2)}</h3>
                    <hr>
                    <p style="text-align: center;">Thank You!</p>
                </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    });

    // Go Back button
    $('#go-back-btn').on('click', function() {
        if ($('#order-summary tbody tr').length > 0) {
            Swal.fire({
                title: 'Leave this page?',
                text: 'You have items in your order. Are you sure you want to leave without saving?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, go back',
                cancelButtonText: 'Stay here'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'orderDetailIndex' %}";
                }
            });
        } else {
            window.location.href = "{% url 'orderDetailIndex' %}";
        }
    });

    // GST checkbox toggle
    $('#apply-gst-checkbox').on('change', function() {
        updateBillSummary();
        
        const isChecked = $(this).is(':checked');
        const message = isChecked ? 
            'GST and service charges will be applied to the bill.' :
            'GST and service charges will NOT be applied to the bill.';
        
        Swal.fire({
            title: isChecked ? 'GST Enabled' : 'GST Disabled',
            text: message,
            icon: isChecked ? 'info' : 'warning',
            timer: 1500,
            showConfirmButton: false
        });
    });

</script>


{% endblock %}