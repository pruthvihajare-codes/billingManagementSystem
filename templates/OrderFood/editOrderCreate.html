{% extends "Shared/dashboard.html" %}
{% load static %}
{% load encryption_filters %}
{% block content %}

<style>
    .custom-radio-group {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .custom-radio input[type="radio"] {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #007bff;
        border-radius: 50%;
        margin-right: 8px;
        cursor: pointer;
    }
    .custom-radio input[type="radio"]:checked {
        background-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,.3);
    }
    .custom-radio {
        display: flex;
        align-items: center;
        font-weight: 500;
    }
</style>

<!-- TAX RATES FROM DATABASE -->
<input type="hidden" id="food-gst-rate" value="{{ tax_rates.food_gst }}">
<input type="hidden" id="drink-gst-rate" value="{{ tax_rates.drink_gst }}">
<input type="hidden" id="service-charge-rate" value="{{ tax_rates.service_charge }}">
<input type="hidden" id="service-charge-enabled" value="{{ tax_rates.service_enabled|yesno:'1,0' }}">

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h2 class="m-0 font-weight-bold text-primary">Edit Food Order</h2>
    </div>
    
    <div class="card-body">
        <!-- REQUIRED HIDDEN FIELDS -->
        <input type="hidden" id="order-id" value="{{ selected_order.order_id|enc }}">
        <input type="hidden" id="TableCategory" value="{{ Category }}">

        <div class="row">
            <!-- LEFT SIDE: ORDER CONTROLS & TABLE -->
            <div class="col-md-8">
                <!-- CONTROLS SECTION -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Add Items</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Table Number -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label font-weight-bold">Table Number</label>
                                    <input type="text" id="service-dropdown"
                                           class="form-control form-control-lg"
                                           value="{{ tableName }}" readonly>
                                </div>
                            </div>

                            <!-- Add Dish -->
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label class="form-label font-weight-bold">Add Dish</label>
                                    <input list="dish-list" id="next-dropdown"
                                           class="form-control form-control-lg" placeholder="Type dish name...">
                                    <datalist id="dish-list">
                                        {% for dish in menu_items %}
                                            <option value="{{ dish }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                            </div>

                            <!-- Portion Size - Dynamic Controls -->
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label font-weight-bold d-block">Portion</label>
                                    <div id="portion-controls">
                                        <!-- Dynamic controls will be loaded here -->
                                        <div class="custom-radio-group">
                                            <label class="custom-radio">
                                                <input type="radio" name="quantity" value="H">
                                                Half
                                            </label>
                                            <label class="custom-radio">
                                                <input type="radio" name="quantity" value="F">
                                                Full
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SELECTED ORDERS TABLE -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Selected Orders</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover mb-0" id="order-summary">
                                <thead class="thead-light sticky-top" style="top: 0;">
                                    <tr>
                                        <th>Dish</th>
                                        <th>Category</th>
                                        <th>Portion</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order_details %}
                                        <tr data-unit-price="{{ item.price }}"
                                            data-order-detail-id="{{ item.id|enc }}"
                                            data-measurement="{{ item.measurement_type|default:'half_full' }}">
                                            <td>{{ item.menu_name }}</td>
                                            <td><span class="badge badge-info">{{ item.menu_category }}</span></td>
                                            <td>
                                                {% if item.measurement_type == 'piece' or item.measurement_type == 'ml' or item.measurement_type == 'bottle' or item.measurement_type == 'glass' or item.measurement_type == 'slice' or item.measurement_type == 'plate' %}
                                                    <span class="badge badge-primary">{{ item.quantity_type }}</span>
                                                {% else %}
                                                    <span class="badge {% if item.quantity_type == 'H' %}badge-warning{% else %}badge-success{% endif %}">
                                                        {% if item.quantity_type == 'H' %}Half{% else %}Full{% endif %}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <input type="number"
                                                       class="form-control form-control-sm dynamic-qty"
                                                       min="1" value="{{ item.quantity }}" style="width: 70px;">
                                            </td>
                                            <td class="price-cell font-weight-bold">₹{{ item.price|floatformat:2 }}</td>
                                            <td>
                                                <button type="button"
                                                        class="btn btn-danger btn-sm delete-row">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDE: BILLING SUMMARY -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <!-- Restaurant Header -->
                    <div class="text-center p-3 bg-dark text-white">
                        <h4 class="mb-1">Restaurant Name</h4>
                        <p class="mb-0 small">Your Restaurant Slogan Here</p>
                        <hr class="my-2" style="border-color: rgba(255,255,255,0.2)">
                    </div>
                    
                    <!-- Bill Details -->
                    <div class="p-3" style="height: calc(100% - 200px); overflow-y: auto;">
                        <!-- Order Info -->
                        <div class="row mb-2 small">
                            <div class="col-6">
                                <strong>Bill No:</strong> {{ selected_order.order_id }}
                            </div>
                            <div class="col-6 text-right">
                                <strong>Date:</strong> {{ selected_order.created_at|date:"d/m/Y" }}
                            </div>
                        </div>
                        <div class="row mb-3 small">
                            <div class="col-12">
                                <strong>Table:</strong> {{ tableName }} ({{ Category }})
                            </div>
                        </div>
                        
                        <!-- Items Table -->
                        <div class="table-responsive mb-3">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr class="bg-light">
                                        <th class="py-1" style="width: 40%">Item</th>
                                        <th class="py-1 text-center" style="width: 20%">Type</th>
                                        <th class="py-1 text-center" style="width: 15%">Qty</th>
                                        <th class="py-1 text-right" style="width: 25%">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="restaurant-bill-items">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Calculations -->
                        <div class="border-top pt-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Subtotal</span>
                                <span id="restaurant-subtotal">₹0.00</span>
                            </div>
                            
                            <!-- GST TOGGLE -->
                            <div class="form-check mb-2 small">
                                <input class="form-check-input" type="checkbox" id="apply-gst-checkbox" 
                                       {% if selected_order.gst_applied %}checked{% endif %}>
                                <label class="form-check-label" for="apply-gst-checkbox">
                                    Apply GST & Service Charges
                                </label>
                            </div>
                            
                            <!-- Tax Breakdown (Dynamic) -->
                            <div id="tax-breakdown">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <strong>TOTAL PAYABLE</strong>
                                <strong id="restaurant-grand-total">₹0.00</strong>
                            </div>
                        </div>
                        
                        <!-- Footer Note -->
                        <div class="text-center mt-3 small text-muted">
                            Thank you for dining with us!
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-4">
                                <button class="btn btn-secondary w-100" id="go-back-btn">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-primary w-100" id="save-order-btn">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-success w-100" id="print-bill-btn">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    $(document).ready(function () {
        updateBillSummary();
        
        // Set initial state for portion controls
        updatePortionControls();
    });

    // Function to update portion controls based on selected dish
    function updatePortionControls() {
        const selectedDish = $('#next-dropdown').val();
        
        if (!selectedDish) {
            // Reset to default if empty
            $('#portion-controls').html(`
                <div class="custom-radio-group">
                    <label class="custom-radio">
                        <input type="radio" name="quantity" value="H">
                        Half
                    </label>
                    <label class="custom-radio">
                        <input type="radio" name="quantity" value="F">
                        Full
                    </label>
                </div>
            `);
        }
    }

    // When dish is selected from dropdown
    $('#next-dropdown').on('change', function() {
        const selectedDish = $(this).val();
        const category = $('#TableCategory').val();
        
        console.log('Dish selected:', selectedDish, 'Category:', category);
        
        if (!selectedDish) {
            updatePortionControls();
            return;
        }
        
        // Get dish details to check measurement type
        $.ajax({
            url: "{% url 'get_dish_details' %}",
            type: 'GET',
            data: {
                dish_name: selectedDish,
                category: category
            },
            success: function(response) {
                console.log('Dish details response:', response);
                if (response.success) {
                    const item = response.item;
                    console.log('Item measurement type:', item.menu_measurement);
                    
                    if (item.menu_measurement !== 'half_full') {
                        console.log('Auto-adding non-half/full item');
                        // Auto-add non-half/full items
                        autoAddNonHalfFullItem(selectedDish, item);
                        $('#next-dropdown').val('');
                    } else {
                        console.log('Showing radio buttons for half/full item');
                        // For half/full items, show radio buttons
                        $('#portion-controls').html(`
                            <div class="custom-radio-group">
                                <label class="custom-radio">
                                    <input type="radio" name="quantity" value="H">
                                    Half
                                </label>
                                <label class="custom-radio">
                                    <input type="radio" name="quantity" value="F">
                                    Full
                                </label>
                            </div>
                        `);
                    }
                } else {
                    console.log('No item found or error:', response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error getting dish details:', error);
                // Default to half/full if error
                $('#portion-controls').html(`
                    <div class="custom-radio-group">
                        <label class="custom-radio">
                            <input type="radio" name="quantity" value="H">
                            Half
                        </label>
                        <label class="custom-radio">
                            <input type="radio" name="quantity" value="F">
                            Full
                        </label>
                    </div>
                `);
            }
        });
    });

    // Handle radio button clicks for half/full items
    $(document).on('change', 'input[name="quantity"]', function() {
        const selectedDish = $('#next-dropdown').val();
        
        if (!selectedDish) {
            Swal.fire('Warning', 'Please select a dish first', 'warning');
            $(this).prop('checked', false);
            return;
        }
        
        addHalfFullItemToOrder();
    });

    // Function to add half/full item to order
    function addHalfFullItemToOrder() {
        const selectedService = $('#service-dropdown').val();
        const selectedDish = $('#next-dropdown').val();
        const selectedQty = $('input[name="quantity"]:checked').val();
        const seatingCategory = $('#TableCategory').val();
        
        if (!selectedQty) {
            Swal.fire('Warning', 'Please select portion size (Half/Full)', 'warning');
            return;
        }
        
        const qtyText = selectedQty === 'H' ? 'Half' : 'Full';
        
        // Check for duplicate
        if (isDishAlreadyAdded(selectedDish, qtyText)) {
            Swal.fire({
                title: 'Duplicate Item',
                text: `${selectedDish} (${qtyText}) is already in the order.`,
                icon: 'info',
                confirmButtonText: 'OK'
            });
            $('#next-dropdown').val('');
            $('input[name="quantity"]').prop('checked', false);
            updatePortionControls();
            return;
        }

        // Get price and add item
        $.ajax({
            url: "{% url 'get_menu_price' %}",
            type: "GET",
            data: {
                menu_name: selectedDish,
                quantity_type: selectedQty,
                seating_category: seatingCategory
            },
            success: function (res) {
                const badgeClass = selectedQty === 'H' ? 'badge-warning' : 'badge-success';

                $('#order-summary tbody').append(`
                    <tr data-unit-price="${res.price}" data-measurement="half_full">
                        <td>${selectedDish}</td>
                        <td><span class="badge badge-info">${res.menu_category}</span></td>
                        <td><span class="badge ${badgeClass}">${qtyText}</span></td>
                        <td>
                            <input type="number"
                                class="form-control form-control-sm dynamic-qty"
                                value="1" min="1" style="width: 70px;">
                        </td>
                        <td class="price-cell font-weight-bold">₹${res.price.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-row">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);

                updateBillSummary();
                $('#next-dropdown').val('');
                $('input[name="quantity"]').prop('checked', false);
                updatePortionControls();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Added!',
                    text: `${selectedDish} (${qtyText}) added to order`,
                    timer: 1500,
                    showConfirmButton: false
                });
            },
            error: function() {
                Swal.fire('Error', 'Item not found or not available', 'error');
                $('input[name="quantity"]').prop('checked', false);
            }
        });
    }

    // Function to auto-add non-half_full items (piece, ml, bottle, etc.)
    function autoAddNonHalfFullItem(dishName, itemDetails) {
        console.log('DEBUG: Starting to add item:', dishName);
        
        // First check if we can get price using get_menu_price endpoint
        const Category = $('#TableCategory').val();
        const seatingCategory = Category; // Assuming this is the same
        
        // Try to get price first
        $.ajax({
            url: "{% url 'get_menu_price' %}",
            type: "GET",
            data: {
                menu_name: dishName,
                quantity_type: 'F', // Use 'F' for piece items
                seating_category: seatingCategory
            },
            success: function (priceRes) {
                console.log('DEBUG: Got price:', priceRes);
                
                const badgeClass = 'badge-primary';
                const qtyDisplay = `1 ${itemDetails.measurement_unit || itemDetails.menu_measurement}`;

                $('#order-summary tbody').append(`
                    <tr data-unit-price="${priceRes.price}" data-measurement="${itemDetails.menu_measurement}">
                        <td>${dishName}</td>
                        <td><span class="badge badge-info">${priceRes.menu_category}</span></td>
                        <td><span class="badge ${badgeClass}">${qtyDisplay}</span></td>
                        <td>
                            <input type="number"
                                class="form-control form-control-sm dynamic-qty"
                                value="1" min="1" style="width: 70px;">
                        </td>
                        <td class="price-cell font-weight-bold">₹${priceRes.price.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-row">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);

                updateBillSummary();
                $('#next-dropdown').val('');
                updatePortionControls();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Added!',
                    text: `${dishName} added to order`,
                    timer: 1500,
                    showConfirmButton: false
                });
            },
            error: function(xhr, status, error) {
                console.error('DEBUG: Error getting price:', error);
                
                // If get_menu_price fails, try a simpler approach
                const unitPrice = parseFloat(itemDetails.menu_full_price) || 0;
                const totalPrice = unitPrice;
                const qtyDisplay = `1 ${itemDetails.measurement_unit || itemDetails.menu_measurement}`;
                
                $('#order-summary tbody').append(`
                    <tr data-unit-price="${unitPrice}" data-measurement="${itemDetails.menu_measurement}">
                        <td>${dishName}</td>
                        <td><span class="badge badge-info">${itemDetails.menu_category}</span></td>
                        <td><span class="badge badge-primary">${qtyDisplay}</span></td>
                        <td>
                            <input type="number" class="form-control form-control-sm dynamic-qty" 
                                min="1" value="1" style="width: 70px;">
                        </td>
                        <td class="price-cell font-weight-bold">₹${totalPrice.toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm delete-row">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);

                updateBillSummary();
                updatePortionControls();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Item Added!',
                    text: `${dishName} added to order`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        });
    }

    // Function to check for duplicates
    function isDishAlreadyAdded(dishName, portionType) {
        let isDuplicate = false;
        
        $('#order-summary tbody tr').each(function () {
            const existingDish = $(this).find('td:eq(0)').text();
            
            if (existingDish === dishName) {
                isDuplicate = true;
                return false;
            }
        });
        
        return isDuplicate;
    }

    // Function to check if category is a drink
    function isDrinkCategory(category) {
        if (!category) return false;
        
        const lowerCategory = category.toLowerCase().trim();
        
        const alcoholicKeywords = [
            'alcohol', 'cocktail', 'wine', 'beer', 'spirit', 'liquor', 'bar',
            'whisky', 'vodka', 'rum', 'gin', 'tequila', 'brandy'
        ];
        
        return alcoholicKeywords.some(keyword => lowerCategory.includes(keyword));
    }

    // Update bill summary function
    function updateBillSummary() {
        let foodTotal = 0;
        let drinkTotal = 0;
        const items = [];
        
        // Get rates from hidden fields
        const foodGstRate = parseFloat($('#food-gst-rate').val()) || 5;
        const drinkGstRate = parseFloat($('#drink-gst-rate').val()) || 18;
        const serviceChargeRate = parseFloat($('#service-charge-rate').val()) || 5;
        const serviceChargeEnabled = $('#service-charge-enabled').val() === '1';
        
        // Check if GST should be applied
        const applyGst = $('#apply-gst-checkbox').is(':checked');
        
        // Clear bill items
        $('#restaurant-bill-items').empty();
        
        // Process each item
        $('#order-summary tbody tr').each(function () {
            const menuName = $(this).find('td:eq(0)').text();
            const category = $(this).find('td:eq(1)').text()
                .replace('badge-info', '')
                .replace('badge', '')
                .replace(/<[^>]*>/g, '')
                .trim();
            const qtyType = $(this).find('td:eq(2)').text().trim();
            const qty = parseInt($(this).find('.dynamic-qty').val()) || 1;
            const priceText = $(this).find('.price-cell').text().replace('₹', '');
            const itemTotal = parseFloat(priceText) || 0;
            
            const isDrink = isDrinkCategory(category);
            
            if (isDrink) {
                drinkTotal += itemTotal;
            } else {
                foodTotal += itemTotal;
            }
            
            items.push({
                name: menuName,
                total: itemTotal,
                isDrink: isDrink
            });
            
            // Add to bill display
            $('#restaurant-bill-items').append(`
                <tr>
                    <td class="small py-1">${menuName}</td>
                    <td class="text-center small py-1">
                        <span class="badge ${qtyType.includes('Half') ? 'badge-warning' : qtyType.includes('Full') ? 'badge-success' : 'badge-primary'}">
                            ${qtyType}
                        </span>
                    </td>
                    <td class="text-center small py-1">${qty}</td>
                    <td class="text-right small py-1">₹${itemTotal.toFixed(2)}</td>
                </tr>
            `);
        });
        
        // Calculate amounts
        const subtotal = foodTotal + drinkTotal;
        
        // Only calculate taxes if GST checkbox is checked
        let foodGst = 0;
        let drinkGst = 0;
        let totalGst = 0;
        let serviceCharge = 0;
        
        if (applyGst) {
            foodGst = (foodTotal * foodGstRate) / 100;
            drinkGst = (drinkTotal * drinkGstRate) / 100;
            totalGst = foodGst + drinkGst;
            
            if (serviceChargeEnabled) {
                serviceCharge = (subtotal * serviceChargeRate) / 100;
            }
        }
        
        const grandTotal = subtotal + totalGst + serviceCharge;
        
        // UPDATE DISPLAY
        $('#restaurant-subtotal').text(`₹${subtotal.toFixed(2)}`);
        
        // Build tax display
        let taxHtml = '';
        
        if (applyGst) {
            if (foodTotal > 0 && foodGst > 0) {
                taxHtml += `<div class="d-flex justify-content-between mb-1 small">
                    <span>Food GST @${foodGstRate}%</span>
                    <span>₹${foodGst.toFixed(2)}</span>
                </div>`;
            }
            
            if (drinkTotal > 0 && drinkGst > 0) {
                taxHtml += `<div class="d-flex justify-content-between mb-1 small">
                    <span>Drink GST @${drinkGstRate}%</span>
                    <span>₹${drinkGst.toFixed(2)}</span>
                </div>`;
            }
            
            if (serviceChargeEnabled && serviceCharge > 0) {
                taxHtml += `<div class="d-flex justify-content-between mb-1 small">
                    <span>Service Charge @${serviceChargeRate}%</span>
                    <span>₹${serviceCharge.toFixed(2)}</span>
                </div>`;
            }
        } else {
            taxHtml = `<div class="text-muted small mb-1">
                <i>GST & Service Charges not applied</i>
            </div>`;
        }
        
        // Update tax breakdown
        $('#tax-breakdown').html(taxHtml);
        $('#restaurant-grand-total').text(`₹${grandTotal.toFixed(2)}`);
        
        return {
            subtotal: subtotal,
            foodGst: foodGst,
            drinkGst: drinkGst,
            totalGst: totalGst,
            serviceCharge: serviceCharge,
            grandTotal: grandTotal,
            items: items
        };
    }

    // Event listeners
    $(document).on('input', '.dynamic-qty', function () {
        const qty = parseInt($(this).val()) || 0;
        const row = $(this).closest('tr');
        
        console.log('Quantity changed:', qty, 'Row:', row);

        if (qty <= 0) {
            Swal.fire('Warning', 'Quantity must be at least 1!', 'warning');
            $(this).val(1);
            return;
        }

        const dish = row.find('td:eq(0)').text();
        const measurementType = row.data('measurement') || 'half_full';
        const Category = $('#TableCategory').val();
        
        console.log('Dish:', dish, 'Measurement type:', measurementType);

        if (measurementType === 'half_full') {
            // For half/full items
            const portionText = row.find('td:eq(2) .badge').text();
            const selectedQty = portionText === 'Half' ? 'H' : 'F';
            
            console.log('Getting price for half/full item');
            
            $.ajax({
                url: "{% url 'get_menu_price' %}",
                type: "GET",
                data: {
                    menu_name: dish,
                    quantity_type: selectedQty,
                    seating_category: Category
                },
                success: function(res) {
                    console.log('Price response:', res);
                    const unitPrice = res.price;
                    const itemTotal = (unitPrice * qty).toFixed(2);
                    
                    row.find('.price-cell').text(`₹${itemTotal}`);
                    row.data('unit-price', unitPrice);
                    updateBillSummary();
                },
                error: function(xhr, status, error) {
                    console.error('Error getting price:', error);
                    Swal.fire('Error', 'Failed to update price', 'error');
                }
            });
        } else {
            // For piece, ml, bottle, glass, slice, plate items
            console.log('Calculating price for measurement type:', measurementType);
            
            const unitPrice = parseFloat(row.data('unit-price')) || 0;
            console.log('Unit price from data:', unitPrice);
            
            // Calculate total price
            const totalPrice = (unitPrice * qty).toFixed(2);
            console.log('Total price:', totalPrice, '= unitPrice', unitPrice, '* qty', qty);
            
            // Update the price cell
            row.find('.price-cell').text(`₹${totalPrice}`);
            
            // Update portion display text
            const currentPortion = row.find('td:eq(2) .badge').text();
            const measurementUnit = getMeasurementUnit(currentPortion, measurementType, qty);
            row.find('td:eq(2) .badge').text(measurementUnit);
            
            // Update bill summary
            updateBillSummary();
        }
    });

    // Helper function to format measurement unit display
    function getMeasurementUnit(currentText, measurementType, qty) {
        switch(measurementType) {
            case 'piece':
                return `${qty} piece${qty > 1 ? 's' : ''}`;
            case 'ml':
                // Extract ml value from current text (e.g., "500ml" -> 500)
                const mlMatch = currentText.match(/(\d+)ml/);
                if (mlMatch) {
                    const mlValue = parseInt(mlMatch[1]);
                    return `${qty} x ${mlValue}ml`;
                }
                return `${qty} bottle${qty > 1 ? 's' : ''}`;
            case 'bottle':
                return `${qty} bottle${qty > 1 ? 's' : ''}`;
            case 'glass':
                return `${qty} glass${qty > 1 ? 'es' : ''}`;
            case 'slice':
                return `${qty} slice${qty > 1 ? 's' : ''}`;
            case 'plate':
                return `${qty} plate${qty > 1 ? 's' : ''}`;
            default:
                return `${qty} item${qty > 1 ? 's' : ''}`;
        }
    }

    // Delete row
    $(document).on('click', '.delete-row', function () {
        const row = $(this).closest('tr');
        const orderDetailIdEnc = row.data('order-detail-id');

        Swal.fire({
            title: 'Are you sure?',
            text: "This item will be removed from the order",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it'
        }).then((result) => {
            if (!result.isConfirmed) return;

            if (!orderDetailIdEnc) {
                row.remove();
                updateBillSummary();
                Swal.fire('Removed', 'Item removed from list.', 'success');
                return;
            }

            $.ajax({
                url: "{% url 'delete_order_item' %}",
                type: "POST",
                data: {
                    order_detail_id: orderDetailIdEnc,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (res) {
                    if (res.status === 'success') {
                        row.remove();
                        updateBillSummary();
                        Swal.fire('Deleted!', 'Item removed successfully.', 'success');
                    }
                }
            });
        });
    });

    // Save Order
    $('#save-order-btn').on('click', function () {
        const items = [];
        const billData = updateBillSummary();  // This returns calculated values
        
        console.log("DEBUG: Bill data from updateBillSummary:", billData);
        
        // Collect items
        $('#order-summary tbody tr').each(function () {
            const dish = $(this).find('td:eq(0)').text();
            const category = $(this).find('td:eq(1)').text().replace('badge-info', '').replace('badge', '').trim();
            const portionText = $(this).find('td:eq(2)').text().trim();
            const measurementType = $(this).data('measurement') || 'half_full';
            const quantity = $(this).find('.dynamic-qty').val();
            const unitPrice = parseFloat($(this).data('unit-price')) || 0;
            
            let quantity_type = 'F';
            if (measurementType === 'half_full') {
                quantity_type = portionText === 'Half' ? 'H' : 'F';
            } else {
                quantity_type = measurementType;
            }
            
            items.push({
                menu_name: dish,
                menu_category: category,
                quantity_type: quantity_type,
                quantity: quantity,
                price: unitPrice,
                measurement_type: measurementType
            });
        });
        
        console.log("DEBUG: Sending to backend:");
        console.log("  Items:", items);
        console.log("  Subtotal:", billData.subtotal);
        console.log("  GST:", billData.totalGst);
        console.log("  Grand Total:", billData.grandTotal);

        $.ajax({
            url: "{% url 'orderUpdateDetails' %}",
            type: "POST",
            data: {
                order_id: $('#order-id').val(),
                order_items: JSON.stringify(items),
                // Send the ALREADY CALCULATED values
                total_amount: billData.subtotal.toFixed(2),
                gst_applied: $('#apply-gst-checkbox').is(':checked') ? 1 : 0,
                gst_amount: billData.totalGst.toFixed(2),
                service_charge: billData.serviceCharge.toFixed(2),
                grand_total: billData.grandTotal.toFixed(2),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                console.log("DEBUG: Backend response:", response);
                Swal.fire({
                    title: 'Success!',
                    text: 'Order updated successfully',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            },
            error: function(xhr, status, error) {
                console.error("DEBUG: Save error:", error, xhr.responseText);
                Swal.fire('Error', 'Failed to update order', 'error');
            }
        });
    });

    // Print Bill
    $('#print-bill-btn').on('click', function() {
        const billData = updateBillSummary();
        const printWindow = window.open('', '_blank');
        
        let taxDetails = '';
        if (billData.foodGst > 0) {
            taxDetails += `<p>Food GST: ₹${billData.foodGst.toFixed(2)}</p>`;
        }
        if (billData.drinkGst > 0) {
            taxDetails += `<p>Drink GST: ₹${billData.drinkGst.toFixed(2)}</p>`;
        }
        if (billData.serviceCharge > 0) {
            taxDetails += `<p>Service Charge: ₹${billData.serviceCharge.toFixed(2)}</p>`;
        }
        
        printWindow.document.write(`
            <html>
                <head><title>Bill</title></head>
                <body style="font-family: monospace; padding: 15px;">
                    <h3 style="text-align: center;">RESTAURANT NAME</h3>
                    <hr>
                    <p><strong>Bill No:</strong> {{ selected_order.order_id }}</p>
                    <p><strong>Table:</strong> {{ tableName }}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                    <hr>
                    
                    <table width="100%">
                        ${billData.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td align="right">₹${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <hr>
                    <p>Subtotal: ₹${billData.subtotal.toFixed(2)}</p>
                    ${taxDetails}
                    <h3>Grand Total: ₹${billData.grandTotal.toFixed(2)}</h3>
                    <hr>
                    <p style="text-align: center;">Thank You!</p>
                </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    });

    // Go Back
    $('#go-back-btn').on('click', function() {
        if ($('#order-summary tbody tr').length > 0) {
            Swal.fire({
                title: 'Leave this page?',
                text: 'You have items in your order. Are you sure you want to leave?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, go back',
                cancelButtonText: 'Stay here'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'orderDetailIndex' %}";
                }
            });
        } else {
            window.location.href = "{% url 'orderDetailIndex' %}";
        }
    });

    // GST checkbox toggle
    $('#apply-gst-checkbox').on('change', function() {
        updateBillSummary();
    });
</script>

{% endblock %}